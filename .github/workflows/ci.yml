name: CI
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: foglio_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'
        
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Create test environment file
      run: |
        cat > .env << EOF
        APP_EMAIL=test@example.com
        API_URL=http://localhost:8080
        CLOUDINARY_KEY=test-key
        CLOUDINARY_NAME=test-cloud
        CLOUDINARY_SECRET=test-secret
        COOKIE_DOMAIN=localhost
        GITHUB_CLIENT_ID=github-client-id
        GITHUB_CLIENT_SECRET=github-client-secret
        GITHUB_CLIENT_PRIVATE_KEY=github-private-key
        GITHUB_REDIRECT_URL=http://localhost:8080/auth/github/callback
        GOOGLE_CLIENT_ID=google-client-id
        GOOGLE_CLIENT_SECRET=google-client-secret
        GOOGLE_REDIRECT_URL=http://localhost:8080/auth/google/callback
        JWT_TOKEN_SECRET=test-jwt-secret
        PORT=8080
        POSTGRES_URL=postgres://postgres:postgres@localhost:5432/foglio_test?sslmode=disable
        PROJECT_ID=test-project
        REDIS_URL=redis://localhost:6379
        SMTP_HOST=smtp.gmail.com
        SMTP_PORT=587
        SMTP_USER=test@example.com
        SMTP_PASSWORD=test-password
        VERSION=v2
        EOF
        
    - name: Install dependencies
      run: go mod download
      
    - name: Run unit tests
      run: go test -v ./src/...
      
    - name: Run e2e tests
      run: go test -v ./tests/...
      env:
        APP_EMAIL: test@example.com
        API_URL: http://localhost:8080
        CLOUDINARY_KEY: test-key
        CLOUDINARY_NAME: test-cloud
        CLOUDINARY_SECRET: test-secret
        COOKIE_DOMAIN: localhost
        GITHUB_CLIENT_ID: github-client-id
        GITHUB_CLIENT_SECRET: github-client-secret
        GITHUB_CLIENT_PRIVATE_KEY: github-private-key
        GITHUB_REDIRECT_URL: http://localhost:8080/auth/github/callback
        GOOGLE_CLIENT_ID: google-client-id
        GOOGLE_CLIENT_SECRET: google-client-secret
        GOOGLE_REDIRECT_URL: http://localhost:8080/auth/google/callback
        JWT_TOKEN_SECRET: test-jwt-secret
        PORT: 8080
        POSTGRES_URL: postgres://postgres:postgres@localhost:5432/foglio_test?sslmode=disable
        PROJECT_ID: test-project
        REDIS_URL: redis://localhost:6379
        SMTP_HOST: smtp.gmail.com
        SMTP_PORT: 587
        SMTP_USER: test@example.com
        SMTP_PASSWORD: test-password
        VERSION: v2
      
    - name: Build application
      run: go build -v ./...

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'
        
    - name: golangci-lint
      uses: golangci/golangci-lint-action@v9
      with:
        version: latest
        args: --timeout=5m

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'
        
    - name: Run Gosec Security Scanner
      uses: securego/gosec@master
      with:
        args: '-no-fail -fmt sarif -out results.sarif ./...'
      env:
        GOFLAGS: '-buildvcs=false'
